<% provide(:title, 'Пользователи') %>

<script>
$(document).ready(function() {
    var t = $('#pstable').DataTable( {
        "order": [[ 4, "desc" ],[ 3, "desc" ]],
        "language": {
            "lengthMenu": "Отображать _MENU_ строк на странице",
            "zeroRecords": "Ничего не найдено - увы...",
            "info": "Страница _PAGE_ из _PAGES_",
            "infoEmpty": "Нет доступных строк",
            "infoFiltered": "(Отфильтровано из _MAX_ строк)",
            "search": "Поиск",
             paginate: {
                first:      "<<",
                previous:   "<",
                next:       ">",
                last:       ">>"
            }
        },
        "pagingType": "full_numbers",
        "pageLength": 25,
         "fixedHeader": {
               headerOffset: ($('#navMenu').outerHeight() - 1)
         },
         responsive: {
            details: {
                type: 'column'
            }
        },
        columnDefs: [ {
            className: 'control',
            orderable: false,
            targets:   0
            }, {
            "searchable": false,
            "orderable": false,
            "targets": 1
            },
         { type: 'de_datetime', targets: [2,7,8,9] }
         ]      
    } ); 
    
    t.on( 'order.dt search.dt', function () {
        t.column(1, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
            cell.innerHTML = i+1;
        } );
    } ).draw();
    
} );

</script>
	  
<div class="container">
<%= link_to('Новый пользователь', users_new_path) %><br />
<%= link_to('Edit current user registration', edit_user_registration_path) %><br />


 <table id="pstable" class="table table-bordered table-condensed table-hover table-striped dt-responsive nowrap compact" style="width:100%">
 <caption>List of users</caption>	
 <% 2.times do |i| %>	
  <% if i==0 then %><thead><% else %><tfoot><% end %>
    <tr class="table-info">
      <th style="width:3%" scope="col"></th>
      <th style="width:2%" scope="col" class="all">№</th>
      <th class="all" scope="col">avatar</th>	
      <th class="all" scope="col">email</th>
      <th class="all" scope="col">Роль</th>
      <th scope="col">Счетчик входов</th>
      <th scope="col">Дата тек. входа</th>
      <th scope="col">Дата посл. входа</th>
      <th scope="col">Дата обновления</th>
      <th scope="col">Дата создания</th>
      <th scope="col">Текущий ip</th>
      <th scope="col">Последний ip</th>
      <th class="none" scope="col"></th> 
    </tr>
   <% if i==0 then %></thead><% else %></tfoot><% end %>
  <% end %>
  <tbody>
  <% @users.each do |item| %>
    <% if item.updated_at > (Time.now.ago($GreenDelay)) %><tr class="success"><% else %><tr><% end %>
    	<td></td>
    	<td scope="row"></td>
    	<td><%= image_tag(url_for(:controller => 'welcome', :action => 'avatar_show', :email => item.email), :alt => 'image', :width => '35', :height => '35') %></td>	
	  	<td><%= item.email %></td>
	  	<td><% case when item.superadmin_role? then %><%= fa_icon "camera-retro" %> <!-- uses brands style -->superadmin 
	  		         <% when item.supervisor_role? then %>><%= fa_icon "chess-king", text: "Администратор" %>
	  		         <% when item.user_role? then %><%= fa_icon "chess-knight", text: "Оператор" %>
	  		         <% else %><%= fa_icon "user-slash", text: "" %><% end %></td>
	  	<td><%= item.sign_in_count %></td>
	  	<td><%= if item.current_sign_in_at then item.current_sign_in_at.strftime('%d.%m.%Y %R') end %></td>
	  	<td><%= if item.last_sign_in_at then item.last_sign_in_at.strftime('%d.%m.%Y %R') end %></td>
	  	<td><%= if item.updated_at then item.updated_at.strftime('%d.%m.%Y %R') end %></td>
	  	<td><%= if item.created_at then item.created_at.strftime('%d.%m.%Y %R') end %></td>
	  	<td><%= item.current_sign_in_ip %></td>
	  	<td><%= item.last_sign_in_ip %></td>
	  	<td><%= link_to " " , users_giveuserrole_path(:id => item.id),:method => :get, :class=> "glyphicon glyphicon-knight", :title => "Назначить пользователю #{item.email} роль Оператор" %>
	  		<%= link_to " " , users_dropallroles_path(:id => item.id),:method => :get, :class=> "glyphicon glyphicon-eye-close", :title => "Послать пользователя #{item.email} к черту" %>
	  		<%= link_to " " , users_givesupervisorrole_path(:id => item.id),:method => :get, :class=> "glyphicon glyphicon-king", :title => "Назначить пользователю #{item.email} роль Администратор" %>
	  		<% if current_user.superadmin_role? then %>
	  		  <%= link_to " " , users_givesuperadminrole_path(:id => item.id),:method => :get, :class=> "glyphicon glyphicon-queen", :title => "Назначить пользователю #{item.email} роль superadmin" %>
	  		<% end %>
	  		<%= link_to_if(1," " , users_dropuser_path(:id => item.id),:method => :get, :class=> "glyphicon glyphicon-remove", :title => "Грохнуть пользователя #{item.email} к чертовой матери", data: { confirm: "Удалить пользователя #{item.email} восвояси?" }) %>
	  	    <%= link_to " " , edit_user_path(:id => item.id),:method => :get, :class=> "glyphicon glyphicon-pencil", :title => "Изменить имя, email или пароль пользователя #{item.email}" %>
	  	</td>	  	
    </tr>
  <% end %>    
  </tbody>
</table>

</div>

